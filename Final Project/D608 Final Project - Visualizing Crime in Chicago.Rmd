---
title: "DATA 608 CUNY Data Science Data Visualization" 
subtitle: "Final Project - Visualizing Crime in Chicago"
author: "Kyle Gilde"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    theme: yeti
    #highlight: 
    code_folding: hide
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: false
---

```{r options_pkgs, echo=F, warning=F, message=F, results=F}

knitr::opts_chunk$set(
                      error = F
                      , message = F
                      #,tidy = T
                      , cache = T
                      , warning = F
                      )

install_load <- function(pkg){
  # Load packages & Install them if needed.
  # CODE SOURCE: https://gist.github.com/stevenworthington/3178163
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE, quietly = TRUE, warn.conflicts = FALSE)
}

# required packages
packages <- c("prettydoc","tidyverse","knitr", "ggthemes", "reshape2", "VIM", "lubridate", "data.table", "ggplot2", "treemap", "vcd", "tmap", "tmaptools", "sf", "leaflet")

install_load(packages)
```

# About the Data Set

+ This [Crimes data set](https://data.cityofchicago.org/Public-Safety/Crimes-2001-to-present/ijzp-q8t2) is made available on the [City of Chicago's Data Portal](https://data.cityofchicago.org) and is sourced from the  Chicago Police Department's CLEAR (Citizen Law Enforcement Analysis and Reporting) system. 

+ Each record is a reported incident of crime, and the set contains nearly 6.6 million records between 1/1/2001 and 4/27/2018. 

+ The Chicago Police Department does not guarantee the completeness of the records and cautions against making comparision over time. Our visualizations will look at changes over time with the caveat that the data set may be missing data at random or not a random.

```{r rawdata, warning=F, message=F, results=F}
#get raw data
setwd("C:\\Users\\kyleg")
memory.limit(size = 16000)
if (!exists("crime_raw")) {
  tryCatch(crime_raw <- read.csv("crime_raw.csv"), 
     error = function(x) {
       print("File not in WD. Downloading from the source.")
       crime_url <- "https://data.cityofchicago.org/api/views/ijzp-q8t2/rows.csv?accessType=DOWNLOAD"
       crime_raw <- read.csv("crime_url")
       write.csv(crime_raw, "crime_raw.csv")
     }
  )
}
```

## The Variables

+ This data set presents some unique visualization challenges since it contains only categorical and no continous variables. 

+ From the data set's original 22 variables, we have retained or derived the following variables. They fall into three categories, and a brief description of them follows:

1. **Crime Variables**

+ `Crime`: 

+ `Crime.Type`: Violent/Nonviolent. We categorized the 

+ `Description`: 

+ `Arrest`: true/false. Whether an arest was made.

+ `Domestic`

2. **Time Variables**

+ From the provided timestamp of the incident, we have parsed the following time dimensions using the `lubridate` package: `Date`, `Year`, `Month`, `DayOfWeek` and `Hour`

3. **Location Variables**

+ `Community.Area`:  [Community Areas](https://data.cityofchicago.org/Facilities-Geographic-Boundaries/Boundaries-Community-Areas-current-/cauq-8yn6)

+ `Location.Description`

```{r munge}
#get the community area table
setwd("C:\\Users\\kyleg")
community_url <- "https://data.cityofchicago.org/api/views/igwz-8jzy/rows.csv?accessType=DOWNLOAD"
if (!exists("community_area_df")){community_area_df <- read.csv(community_url)}
community_area_key <- dplyr::select(community_area_df, c(AREA_NUMBE, COMMUNITY))

#munge data
if (!exists("crime_df")){
    crime_df <- 
       crime_raw %>% 
       data.table() %>% 
       filter(Year < 2018) %>% 
       #sample_n(500000) %>% 
       left_join(community_area_key, 
             by = c("Community.Area" = "AREA_NUMBE")) %>% 
       mutate(
          DateTime = lubridate::mdy_hms(as.character(Date)),
          Date_rw = as.Date.POSIXct(DateTime),
          Year = as.ordered(Year),
          Month = month(DateTime, label = T),
          DayOfMonth = as.ordered(day(DateTime)),
          DayOfWeek = wday(DateTime, label = T),
          Hour = as.ordered(hour(DateTime)),
          Crime.Type = as.factor(
          ifelse(Primary.Type %in% c("ROBBERY", "BURGLARY", 
               "CRIM SEXUAL ASSAULT", "HOMICIDE", "HUMAN TRAFFICKING",
               "BATTERY", "MOTOR VEHICLE THEFT", "SEX OFFENSE",
               "KIDNAPPING", "DOMESTIC VIOLENCE", "ASSAULT", "ARSON",
               "INTIMIDATION"), 
             "Violent", "Nonviolent"))
         ) %>% 
       dplyr::select(
         c(Crime = Primary.Type, Crime.Type, Crime.Description = Description, Arrest, Domestic, 
         DateTime, Date = Date_rw, Year, Month, DayOfMonth, DayOfWeek, Hour,
         Community.Area = COMMUNITY, Location.Description))  
} 
```

## Why this data set

Over the last several years, Chicago has become a trope for urban crime & violence in our social and political discourse. However, I have comfortably in the city for nearly a decade without incident. Let's explore how incidents of crime in Chicago vary across time & space.


## Examine Missing Values

Our first plot uses the `VIM` package, which is an acronym for the Visualization and Imputation of Missing Values. 

```{r missing, fig.width=10, fig.height=10, results=F}
## Missing Values
memory.limit(16000)
missing_plot <- VIM::aggr(crime_df,  
                      numbers = T, 
                      sortVars = T,
                      col = c("lightgreen", "darkred", "orange"),
                      labels=str_sub(names(crime_df), 1, 8), 
                      ylab=c("Missing Value Counts", "Pattern"))


summary(missing_plot)
```

# Exploring the Data Set

## Categorical Variable Values

Let's take a look at the frequencies of the categorical variable values.

```{r catvalues, fig.width=12, fig.height=12}
###Categorical & Discrete variables Frequencies
cat_value_freq <-  
  crime_df %>% 
  select_if(is.factor) %>% 
  select_if(function(x) !is.ordered(x)) %>% 
  gather("var", "value") %>% 
  group_by(var) %>% 
  count(var, value) %>%
  mutate(prop = prop.table(n)) %>% 
  filter(prop > .02)

cat_plot1 <- 
  ggplot(data = cat_value_freq, 
       aes(x = reorder(value, prop), y = prop)) + 
  geom_bar(stat = "identity", fill = "tomato3") + 
  facet_wrap(~var, scales = "free") +
  coord_flip() + 
  ggthemes::theme_fivethirtyeight()

cat_plot1
# https://stackoverflow.com/questions/34860535/how-to-use-dplyr-to-generate-a-frequency-table?utm_medium=organic&utm_source=google_rich_qa&utm_campaign=google_rich_qa
```
**Source(s):** []()

## Treemap Crime & Description

```{r Treemap, fig.width=10, fig.height=10}
treemap_df <-
  crime_df %>%
  group_by(Crime, Crime.Description) %>%
  summarize(n = n())

treemap(treemap_df, index=c("Crime","Crime.Description"), 
        vSize="n", type="index",
        fontsize.labels=c(15,12),
        fontcolor.labels=c("white","orange"),
        fontface.labels=c(2,1), 
        bg.labels=c("transparent"),
        align.labels=list(
          c("center", "center"), 
          c("center", "center")
        ),                                 
        overlap.labels=0.1,                     
        inflate.labels=F
      )

```
**Source(s):** [Custom Treemaps](https://www.r-graph-gallery.com/236-custom-your-treemap/)


## Mosiac Plot  

```{r, fig.width=10, fig.height=10}
top_violent_crimes <- names(sort(table(subset(crime_df, Crime.Type == "Violent", select = Crime)), decreasing = T)[1:5])

mosaic_data <- 
  crime_df %>% 
  filter(Crime %in% top_violent_crimes) %>% 
  dplyr::select(c(Crime, Arrest)) %>% 
  mutate_if(is.factor, as.character) %>% 
  mutate(Crime = ifelse(Crime == "MOTOR VEHICLE THEFT", "AUTO THEFT", Crime)) %>% 
  table()

vcd::mosaic(mosaic_data, shade = T, legend = TRUE)
```
**Source(s):** [Visualizing Multivariate Categorical Data](http://www.sthda.com/e
nglish/articles/32-r-graphics-essentials/129-visualizing-multivariate-categorical-data/)


## Balloon Plot

```{r balloon, fig.width=10, fig.height=10}
install_load(c("ggpubr", "viridis"))


#crime_df[, c("Crime", "Location.Description")]

top_violent_crimes <- names(sort(table(subset(crime_df, Crime.Type == "Violent", select = Crime)), decreasing = T)[1:5])

balloon_data <- 
  crime_df %>% 
  filter(Crime %in% top_violent_crimes) %>% 
  group_by(Crime, Location.Description) %>% 
  #summarize(n = n()) %>%
  count() %>%
  mutate(prop = prop.table(n)) %>% 
  filter(prop  > .02)

ggpubr::ggballoonplot(data = balloon_data, fill = "n") +
  scale_fill_viridis(option = "C")
  

```
**Source(s):** [Visualizing Multivariate Categorical Data](http://www.sthda.com/e
nglish/articles/32-r-graphics-essentials/129-visualizing-multivariate-categorical-data/)

mosaic(HairEyeColor, shade = TRUE, legend = TRUE) 
## gballoonplot() [in ggpubr]


# Crime Across Time

## The General Trend

```{r trend, fig.width=10, fig.height=10}
total_crime_17years <-
  crime_df %>% 
  mutate_if(is.factor, as.character) %>% 
  mutate(Year = as.integer(as.character(Year))) %>% 
  group_by(Crime.Type, Year) %>% 
  summarize(reported_incidents = n()) 

ggplot(data = total_crime_17years, aes(x = Year, y = reported_incidents, fill = Crime.Type)) +
  geom_area() + 
  theme_fivethirtyeight()
```

## Small Multiples of Crimes

```{r, fig.width=10, fig.height=10}
crime_17years <-
  crime_df %>% 
  mutate_if(is.factor, as.character) %>% 
  mutate(Year = as.integer(as.character(Year))) %>% 
  #dplyr::select(Year, Crime) %>% 
  group_by(Crime, Year) %>% 
  summarize(reported_incidents = n()) %>% 
  group_by(Crime) %>% 
  mutate(total_years = n()) %>% 
  filter(total_years > 15)


ggplot(data = crime_17years, aes(x = Year, y = reported_incidents, color = "red")) + 
  geom_line() + facet_wrap(~Crime) + 
  theme_fivethirtyeight()
```
## Animated Bubble chart library(gganimate) library(gapminder)

## Heatmap: Crime Incidents by Time of Day and Day of Week

```{r Heatmap, fig.width=10, fig.height=10}

heatmap_data <- 
  crime_df %>% 
  dplyr::select(DayOfWeek, Hour) %>% 
  table()
  
heatmap(heatmap_data, Colv = NA, Rowv = NA, scale="column")


```
**Source(s):** []()
https://www.r-graph-gallery.com/215-the-heatmap-function/

## Violent Crime by Month

forecast::ggseasonplot

time-series object

```{r ggseasonplot, fig.width=10, fig.height=10}
install_load(c("forecast", "fpp2", "zoo"))

violent_df <-
  crime_df %>% 
  #dplyr::filter(Crime == "HOMICIDE") %>% 
  dplyr::group_by(Year, Month) %>%
  arrange(Year, Month) %>% 
  summarise(Reported_incidents = sum(ifelse(Crime.Type == "Violent", 1, 0))) 

#create time-series object
violent_ts <- ts(violent_df$Reported_incidents, start=c(2001, 1), end=c(2017, 12), frequency=12)    

ggseasonplot(violent_ts, year.labels=TRUE, year.labels.left=TRUE) +
  ylab("Reported Incidents") +
  ggtitle("Seasonal plot of Violent Crime Incidents")


```
**Source(s):** [Create maps in R in 10 (fairly) easy steps](https://www.computerworld.com/article/3038270/data-analytics/create-maps-in-r-in-10-fairly-easy-steps.html)

# Crime by Community Area

## Cloropleth

```{r Cloropleth, fig.width=10, fig.height=10}
#summerize by community area
ca_data <- 
  crime_df %>% 
  group_by(Community.Area, Crime.Type) %>% 
  na.omit() %>% 
  summarize(Reported_incidents = n()) %>% 
  spread(Crime.Type, Reported_incidents) %>% 
  ungroup() %>% 
  mutate(Violent_incident_rank = rank(-Violent))

##Download shape file:
##https://data.cityofchicago.org/api/geospatial/cauq-8yn6?method=export&format=Shapefile
Chicago_shp <- tmaptools::read_shape(file="C:\\Users\\kyleg\\D608-Data-Viz\\Final Project\\Chicago.shp\\geo_export_9d342e48-03e4-4de6-8064-407cebb2a418.shp", as.sf = TRUE)

Chicago_shp <- 
  Chicago_shp %>% 
  left_join(ca_data, by = c("community" = "Community.Area"))

violent_palette <- colorNumeric(palette = "Reds"
                                , domain = Chicago_shp$Violent)

tooltips <- paste0(Chicago_shp$community, 
                   "  - Violent incidents: ",
                   formatC(Chicago_shp$Violent, big.mark=","),
                   " - Rank: ", Chicago_shp$Violent_incident_rank)


Chicago_map <- sf::st_transform(Chicago_shp, "+proj=longlat +datum=WGS84")
  
leaflet(Chicago_map) %>% 
  addProviderTiles("CartoDB.PositronNoLabels") %>%
  #select backgrounds:http://leaflet-extras.github.io/leaflet-providers/preview/index.html
  addPolygons(stroke = F,
              smoothFactor = .02,
              fillOpacity = .6,
              popup = tooltips,
              color = ~violent_palette(Chicago_shp$Violent))


#tmap::qtm(Chicago_shp,  "Reported_incidents")

## Community Areas
## Population Pyramid: Community Areas by Crime.Type
##http://r-statistics.co/Top50-Ggplot2-Visualizations-MasterList-R-Code.html
```
**Source(s):** [Create maps in R in 10 (fairly) easy steps](https://www.computerworld.com/article/3038270/data-analytics/create-maps-in-r-in-10-fairly-easy-steps.html)




