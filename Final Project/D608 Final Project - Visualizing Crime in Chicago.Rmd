---
title: "DATA 608 CUNY Data Science Data Visualization" 
subtitle: "Final Project - Visualizing Crime in Chicago"
author: "Kyle Gilde"
date: "5/15/2018"
output: 
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    toc: true
    toc_depth: 2

---

```{r knitr_options, echo=FALSE}

knitr::opts_chunk$set(
                      error = F
                      , message = T
                      #,tidy = T
                      , cache = T
                      , warning = F
                      , echo = F
                      )

```



```{r packages, echo=F, warning=F, message=F, results=F} 
load_install <- function(pkg){
  # Load packages & Install them if needed.
  # CODE SOURCE: https://gist.github.com/stevenworthington/3178163
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE, quietly = TRUE, warn.conflicts = FALSE)
}
# remove.packages("tidyverse")
# install.packages("tidyverse", dependencies=TRUE)
# required packages
packages <- c("prettydoc","tidyverse","DT", "knitr", "ggthemes", "psych", "corrplot", "reshape2", "VIM", "GGally", "anytime", "lubridate", "data.table", "treemapify")
load_install(packages)
```


```{r rawdata}
#get raw data
setwd("C:\\Users\\kyleg")
crime_url <- "https://data.cityofchicago.org/api/views/ijzp-q8t2/rows.csv?accessType=DOWNLOAD"
if (!exists("crime_raw")) {
  tryCatch(crime_raw <- read.csv("crime_raw.csv"), 
           error = function(x) {
             print("File not in WD. Downloading from the source.")
             crime_raw <- read.csv("crime_url")
             }
  )
}
```

```{r munge}
setwd("C:\\Users\\kyleg")
#get the community area table
community_url <- "https://data.cityofchicago.org/api/views/igwz-8jzy/rows.csv?accessType=DOWNLOAD"
if (!exists("community_area_df")){
  community_area_df <- read.csv(community_url)
}
community_area_key <- dplyr::select(community_area_df, c(AREA_NUMBE, COMMUNITY))

#if (!exists("crime_df")){   
  crime_df <- 
     crime_raw %>% 
     data.table() %>% 
     filter(Year < 2018) %>% 
     sample_n(500000) %>% 
     left_join(community_area_key, 
           by = c("Community.Area" = "AREA_NUMBE")) %>% 
     mutate(
        DateTime = lubridate::mdy_hms(as.character(Date)),
        Date_rw = as.Date.POSIXct(DateTime),
        Year = as.ordered(Year),
        Month = month(DateTime, label = T),
        DayOfMonth = as.ordered(day(DateTime)),
        DayOfWeek = wday(DateTime, label = T),
        Hour = as.ordered(hour(DateTime)),
        Crime.Type = as.factor(
        ifelse(Primary.Type %in% c("ROBBERY", "BURGLARY", 
             "CRIM SEXUAL ASSAULT", "HOMICIDE", "HUMAN TRAFFICKING",
             "BATTERY", "MOTOR VEHICLE THEFT", "SEX OFFENSE",
             "KIDNAPPING", "DOMESTIC VIOLENCE", "ASSAULT", "ARSON",
             "INTIMIDATION"), 
           "Violent", "Nonviolent"))
       ) %>% 
     dplyr::select(
       c(Crime = Primary.Type, Crime.Type, Crime.Description = Description, Arrest, Domestic, 
       DateTime, Date = Date_rw, Year, Month, DayOfMonth, DayOfWeek, Hour,
       Community.Area = COMMUNITY, Latitude, Longitude, Location.Description)) 
    
#} 
```



# About the Data Set

This [Crimes data set](https://data.cityofchicago.org/Public-Safety/Crimes-2001-to-present/ijzp-q8t2) is made available on the [City of Chicago's Data Portal](https://data.cityofchicago.org) and is sourced from the  Chicago Police Department's CLEAR (Citizen Law Enforcement Analysis and Reporting) system. Each record is a reported incident of crime, and the set contains nearly 6.6 million records between 1/1/2001 and 4/27/2018. The Chicago Police Department does not guarantee the completeness of the records and cautions against making comparision over time.

## Missing Values

```{r missing, fig.width=11, fig.height=11, results=F}
## Missing Values
memory.limit(16000)
#par(mar = c(10,4,4,2) + 0.1)
missing_plot <- VIM::aggr(crime_df,  
                      numbers = T, 
                      sortVars = T,
                      col = c("lightgreen", "darkred", "orange"),
                      #only.miss = T,
                      #combined = T, 
                      labels=str_sub(names(crime_df), 1, 8), 
                      ylab=c("Missing Value Counts"
                             , "Pattern"))


#par(oma=c(2,0,0,0))
par(mar=c(3,0,0,0))
#hist(1:1000)
summary(missing_plot)






```

## The Variables

From the data set's original 22 variables, we have retained some of them and derived new variables. The new set of variables that fall into three categories and a brief description of them follows:

1. Crime Variables:

+ `Crime`: 

+ `Crime.Type`: We categorized the 

+ `Description`:

+ `Arrest`:

+ `Domestic`

2. Time Variables:

+ From the provided timestamp of the incident, we have parsed the following time dimensions using the `lubridate` package: `Date`, `Year`, `Month`, `DayOfMonth`,  `DayOfWeek` and `Hour`

3. Location Variables

+ `Community.Area`:  [Community Areas](https://data.cityofchicago.org/Facilities-Geographic-Boundaries/Boundaries-Community-Areas-current-/cauq-8yn6)

+ `Latitude`  

+ `Longitude`  

+ `Location.Description`

variables include the date and time, lat/long, neighborhood, type of location, crime category, and whether an arrest was made.

```{r}
str(crime_raw)
str(crime_df)
names(crime_df)
```




```{r stats}
sort(table(crime_df$Year), decreasing = T)

summary(crime_df)

str(crime_df)
```

# Explore Data Set

## Categorical Variable Values

```{r catvalues, fig.width=12, fig.height=12}
#devtools::install_github('hadley/ggplot2')
install_load("plotly")
#install.packages("tidyverse")

###Categorical & Discrete variables Frequencies
cat_value_freq <-  
  crime_df %>% 
  select_if(is.factor) %>% 
  select_if(function(x) !is.ordered(x)) %>% 
  gather("var", "value") %>% 
  group_by(var) %>% 
  count(var, value) %>%
  mutate(prop = prop.table(n)) %>% 
  filter(prop > .02)

p <- 
  ggplot(data = cat_value_freq, 
       aes(x = reorder(value, prop), y = prop)) + 
  geom_bar(stat = "identity", fill = "tomato3") + 
  facet_wrap(~var, scales = "free") +
  coord_flip() + 
  ggthemes::theme_fivethirtyeight()

ggplotly(p)

# https://stackoverflow.com/questions/34860535/how-to-use-dplyr-to-generate-a-frequency-table?utm_medium=organic&utm_source=google_rich_qa&utm_campaign=google_rich_qa
```


```{r ord_cat_value, fig.width=12, fig.height=12}
ord_cat_value_freq <-   
  select_if(crime_df, is.ordered) %>% 
  gather("var", "value") %>% 
  group_by(var) %>% 
  count(var, value) %>%
  mutate(prop = prop.table(n)) %>% 
  filter(prop > .02)

ggplot(data = ord_cat_value_freq, 
       aes(x = reorder(value, prop),
       y = prop)) + 
  geom_bar(stat = "identity", fill = "tomato3") + 
  facet_wrap(~var, scales = "free") +
  coord_flip() + 
  ggthemes::theme_fivethirtyeight()

```


## Tree map library(treemapify) Crime & Description

```{r Treemap, fig.width=12, fig.height=12}


treemap_df <- 
  crime_df %>% 
  dplyr::select(c(parent = Crime,
                  id = Crime.Description)) %>% 
  group_by() %>% 
  count(parent, id)

treeMapCoordinates <- treemapify(treemap_df,
                                 area = "n"#,
                                 #fill = "parent",
                                 # label = "id",
                                 #group = "parent"
                                 )

# treeMapPlot <- ggplotify(treeMapCoordinates) +
#                   scale_x_continuous(expand = c(0, 0)) +
#                   scale_y_continuous(expand = c(0, 0)) +
#                   scale_fill_brewer(palette = "Dark2")

ggplot2::ggplot(treeMapCoordinates
                ) + geom_treemap(ggplot2::aes(area = n, fill = n))
print(treeMapPlot)

```

## Mosiac Chart  library(GoodmanKruskal) library(vcd)

mosaic(HairEyeColor, shade = TRUE, legend = TRUE) 
## gballoonplot() [in ggpubr]
http://www.sthda.com/english/articles/32-r-graphics-essentials/129-visualizing-multivariate-categorical-data/

# Crime Across Time
## Day of Week by Hour Heatmap
## forecast::ggseasonplot
## continuous datatime by 
## other periodicity
## Animated Bubble chart library(gganimate) library(gapminder)
https://www.r-bloggers.com/to-eat-or-not-to-eat-thats-the-question-measuring-the-association-between-categorical-variables/

# Crime by Community Area
## Bivariate Cloropleth
## Community Areas
## Population Pyramid: Community Areas by Crime.Type
http://r-statistics.co/Top50-Ggplot2-Visualizations-MasterList-R-Code.html

